{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sehaat Saathi Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'front/neon_theme.css' %}">
    <style>
        body { padding-top: 20px; }
        .card { margin-bottom: 20px; }
        .table img { max-width: 100px; }
        canvas {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            min-height: 300px;
        }
        @media print {
            body { background-color: white !important; color: black !important; }
            .navbar, .btn, .nav-tabs, footer, .glass-card { display: none !important; }
            .card { border: 1px solid #ddd !important; box-shadow: none !important; background: white !important; color: black !important; }
            canvas { background: white !important; border: 1px solid #ddd; }
            .table { color: black !important; }
            h1, h2, h3, h4 { color: black !important; }
            * { text-shadow: none !important; box-shadow: none !important; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Sehaat Saathi Dashboard</h1>
            <div>
                <span class="me-3">Welcome, {{ user.username }}</span>
                <a href="{% url 'lab-analyzer' %}" class="btn btn-success me-2">Lab Analyzer</a>
                <a href="{% url 'download-report' %}" class="btn btn-outline-info me-2">Download PDF Report</a>
                <a href="{% url 'index' %}" class="btn btn-outline-primary">Home</a>
            </div>
        </div>

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="diabetes-tab" data-bs-toggle="tab" data-bs-target="#diabetes" type="button" role="tab">Diabetes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="heart-tab" data-bs-toggle="tab" data-bs-target="#heart" type="button" role="tab">Heart</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="liver-tab" data-bs-toggle="tab" data-bs-target="#liver" type="button" role="tab">Liver</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cancer-tab" data-bs-toggle="tab" data-bs-target="#cancer" type="button" role="tab">Cancer</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button" role="tab">Image Analysis</button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="myTabContent">
            <!-- Diabetes Tab -->
            <div class="tab-pane fade show active" id="diabetes" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8 mx-auto">
                                <canvas id="diabetesChart"></canvas>
                            </div>
                        </div>
                        <h4 class="card-title mt-3">Recent Records</h4>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Glucose</th>
                                    <th>BP</th>
                                    <th>BMI</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in diabetes_records %}
                                <tr>
                                    <td>{{ record.date|date:"Y-m-d H:i" }}</td>
                                    <td>{{ record.glucose }}</td>
                                    <td>{{ record.blood_pressure }}</td>
                                    <td>{{ record.bmi }}</td>
                                    <td>
                                        <span class="badge {% if 'Diabetic' in record.prediction %}bg-danger{% else %}bg-success{% endif %}">
                                            {{ record.prediction }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center">No diabetes records found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Heart Tab -->
            <div class="tab-pane fade" id="heart" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                         <div class="row">
                            <div class="col-md-8 mx-auto">
                                <canvas id="heartChart"></canvas>
                            </div>
                        </div>
                        <h4 class="card-title mt-3">Recent Records</h4>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Age</th>
                                    <th>Resting BP</th>
                                    <th>Cholesterol</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in heart_records %}
                                <tr>
                                    <td>{{ record.date|date:"Y-m-d H:i" }}</td>
                                    <td>{{ record.age }}</td>
                                    <td>{{ record.resting_bp }}</td>
                                    <td>{{ record.cholesterol }}</td>
                                    <td>
                                        <span class="badge {% if 'Presence' in record.prediction or 'High' in record.prediction %}bg-danger{% else %}bg-primary{% endif %}">
                                            {{ record.prediction }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center">No heart records found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Liver Tab -->
             <div class="tab-pane fade" id="liver" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Age</th>
                                    <th>Total Bilirubin</th>
                                    <th>Albumin</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in liver_records %}
                                <tr>
                                    <td>{{ record.date|date:"Y-m-d H:i" }}</td>
                                    <td>{{ record.age }}</td>
                                    <td>{{ record.total_bilirubin }}</td>
                                    <td>{{ record.albumin }}</td>
                                    <td>{{ record.prediction }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center">No liver records found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Cancer Tab -->
             <div class="tab-pane fade" id="cancer" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in cancer_records %}
                                <tr>
                                    <td>{{ record.date|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        <span class="badge {% if 'Malignant' in record.prediction or 'Positive' in record.prediction %}bg-danger{% else %}bg-success{% endif %}">
                                            {{ record.prediction }}
                                        </span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="2" class="text-center">No cancer records found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Image Tab -->
            <div class="tab-pane fade" id="images" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Image</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in image_records %}
                                <tr>
                                    <td>{{ record.date|date:"Y-m-d H:i" }}</td>
                                    <td>{{ record.disease_type }}</td>
                                    <td>
                                        {% if record.image_path %}
                                            <a href="{{ record.image_path }}" target="_blank" class="btn btn-sm btn-info">View</a>
                                        {% else %}
                                            No Image
                                        {% endif %}
                                    </td>
                                    <td>{{ record.prediction }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="4" class="text-center">No image analysis records found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Data from Django View
            const diabetesData = {
                dates: JSON.parse('{{ d_dates|safe }}'),
                glucose: JSON.parse('{{ d_glucose|safe }}'),
                bmi: JSON.parse('{{ d_bmi|safe }}')
            };

            const heartData = {
                dates: JSON.parse('{{ h_dates|safe }}'),
                bp: JSON.parse('{{ h_bp|safe }}'),
                cholesterol: JSON.parse('{{ h_chol|safe }}')
            };

            // Chart Configuration Standard
            Chart.defaults.color = '#fff';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';
            
            let diabetesChartInstance = null;
            let heartChartInstance = null;

            function initDiabetesChart() {
                const ctx = document.getElementById('diabetesChart');
                if (!ctx || diabetesChartInstance) return;

                if (diabetesData.dates.length > 0) {
                    diabetesChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: diabetesData.dates,
                            datasets: [{
                                label: 'Glucose Level',
                                data: diabetesData.glucose,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.3,
                                fill: true
                            }, {
                                label: 'BMI',
                                data: diabetesData.bmi,
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                title: { display: true, text: 'Glucose & BMI Trends' }
                            },
                            scales: {
                                y: {
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                },
                                x: {
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                }
                            }
                        }
                    });
                } else {
                    ctx.parentElement.innerHTML = '<div class="text-center p-5 text-muted">No diabetes data recorded yet. Take a test to see analytics!</div>';
                }
            }

            function initHeartChart() {
                const ctx = document.getElementById('heartChart');
                if (!ctx || heartChartInstance) return;

                if (heartData.dates.length > 0) {
                    heartChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: heartData.dates,
                            datasets: [{
                                label: 'Resting BP',
                                data: heartData.bp,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.3,
                                fill: true
                            }, {
                                label: 'Cholesterol',
                                data: heartData.cholesterol,
                                borderColor: 'rgb(255, 205, 86)',
                                backgroundColor: 'rgba(255, 205, 86, 0.2)',
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                title: { display: true, text: 'Heart Health Metrics' }
                            },
                            scales: {
                                y: {
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                },
                                x: {
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                }
                            }
                        }
                    });
                } else {
                    ctx.parentElement.innerHTML = '<div class="text-center p-5 text-muted">No heart data recorded yet. Take a test to see analytics!</div>';
                }
            }

            // Initialize Diabetes chart immediately (since it's the active tab)
            initDiabetesChart();

            // Listen for Tab Switches to initialize hidden charts
            const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabEls.forEach(tabEl => {
                tabEl.addEventListener('shown.bs.tab', function (event) {
                    if (event.target.id === 'heart-tab') {
                        initHeartChart();
                    }
                    // If you add charts for liver/cancer later, add them here
                });
            });
        });
    </script>
    {% include 'chat_widget.html' %}
</body>
</html>